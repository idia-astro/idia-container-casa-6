Bootstrap: debootstrap
MirrorURL: http://archive.ubuntu.com/ubuntu/
OSVersion: bionic
Include: software-properties-common

%labels

        APPLICATION_NAME Ubuntu LTS + CASA 6
        OS_VERSION 18.04
        APPLICATION_URL https://casa.nrao.edu/casadocs/latest/usingcasa/obtaining-and-installing

        SYSTEM_NAME iLifu
        SYSTEM_SINGULARITY_VERSION 2.6
        SYSTEM_URL http://www.ilifu.ac.za

        AUTHOR_NAME Jeremy Smith
        AUTHOR_EMAIL jeremy@idia.ac.za

# paths to download wheels that are needed:
# https://casa-pip.nrao.edu/repository/pypi-casa-release/packages/casatools/6.1.2.7/casatools-6.1.2.7-cp36-cp36m-linux_x86_64.whl
# https://casa-pip.nrao.edu/repository/pypi-casa-release/packages/casatasks/6.1.2.7/casatasks-6.1.2.7-py3-none-any.whl
# https://casa-pip.nrao.edu/repository/pypi-casa-release/packages/casampi/0.3.0/casampi-0.3.0-py3-none-any.whl

# https://casa-pip.nrao.edu/repository/pypi-casa-release/packages/casaviewer/1.0.13/casaviewer-1.0.13-py3-none-linux_x86_64.whl
# https://casa-pip.nrao.edu/repository/pypi-casa-release/packages/casaplotms/1.0.25/casaplotms-1.0.25-py3-none-linux_x86_64.whl

%files
        casatools-6.1.2.7-cp36-cp36m-linux_x86_64.whl /opt/
        casatasks-6.1.2.7-py3-none-any.whl /opt/
        casampi-0.3.0-py3-none-any.whl /opt/
        casaviewer-1.0.13-py3-none-linux_x86_64.whl /opt/
        casaplotms-1.0.25-py3-none-linux_x86_64.whl /opt/

%environment
        export PATH=/anaconda3/bin:${PATH}

%post
        # Get and set some system information to speed up compilation
        NUM_CPUS=$(grep -c ^processor /proc/cpuinfo)
        MAKEFLAGS="-j ${NUM_CPUS}"

        # Create Installation Directories and export paths. This is needed as part of post.
        # %environment scriptlet does not define these paths during %post, only after.

        # Installation of initial packages
        apt-get update -y
        apt-get upgrade -y
        add-apt-repository universe
        apt-get install -y wget vim apt-utils git bzip2 build-essential gfortran libgfortran3 xvfb ghostscript curl pkg-config

        # Install OpenMPI
	cd /opt
	wget -O - https://download.open-mpi.org/release/open-mpi/v4.0/openmpi-4.0.5.tar.bz2 | tar jz
        cd openmpi-4.0.5
        ./configure
        make all install
        ldconfig

	# Install Anaconda for python package management
        cd /opt
        wget https://repo.continuum.io/archive/Anaconda3-5.2.0-Linux-x86_64.sh
        bash Anaconda3-5.2.0-Linux-x86_64.sh -b -p /anaconda3
        rm Anaconda3-5.2.0-Linux-x86_64.sh
        export PATH="/anaconda3/bin:$PATH"

        # Update python to 3.6.8 for compatibility with PyBDSF
        conda install -y python==3.6.8	

        # Update pip and install python packages
        pip install --no-cache-dir --upgrade pip
        pip install --no-cache-dir --upgrade cloudpickle holoviews datashader bokeh pandas dask-ms[xarray] scipy
        conda install -y -c conda-forge phantomjs        

        # Install Jupyter for IPykernel
        pip install --no-cache-dir jupyter ipykernel

        # Install PyBDSF
        apt-get install -y libboost-python-dev libboost-numpy-dev python-setuptools
        pip install --no-cache-dir --upgrade numpy scikit-image
        pip install --no-cache-dir astropy pyfits bdsf matplotlib


        # Install CASA 6
#        apt-get install -y libopenmpi-dev
        pip install --no-cache-dir /opt/casatools-6.1.2.7-cp36-cp36m-linux_x86_64.whl
        pip install --no-cache-dir /opt/casatasks-6.1.2.7-py3-none-any.whl
        pip install --no-cache-dir /opt/casampi-0.3.0-py3-none-any.whl

        # Install unvalidated packages
        pip install --no-cache-dir /opt/casaviewer-1.0.13-py3-none-linux_x86_64.whl
        pip install --no-cache-dir /opt/casaplotms-1.0.25-py3-none-linux_x86_64.whl

        # Fix command prompt in Singularity 3.5.2
        printf 'export PS1="\u@$SINGULARITY_NAME:\w$ "' > /.singularity.d/env/999-psvars.sh

        # Cleanup the container
        apt-get clean
        apt-get autoclean

%runscript

	python "$@"
