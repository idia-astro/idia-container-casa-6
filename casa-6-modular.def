BootStrap: docker
From: ubuntu:20.04

%labels
        APPLICATION_NAME Ubuntu LTS + CASA 6
        OS_VERSION 20.04
        APPLICATION_URL https://casa.nrao.edu/casadocs/latest/usingcasa/obtaining-and-installing

        SYSTEM_NAME iLifu
        SYSTEM_SINGULARITY_VERSION 3.5.2
        SYSTEM_URL http://www.ilifu.ac.za

        AUTHOR_NAME IDIA
        AUTHOR_EMAIL support@ilifu.ac.za

%environment

        export PYTHONPATH=$PYTHONPATH:/opt/casaaddons
	export XDG_RUNTIME_DIR=$HOME

%post

        # Create Installation Directories and export paths. This is needed as part of post.
        # %environment scriptlet does not define these paths during %post, only after.
        mkdir -p /opt
        export DEBIAN_FRONTEND=noninteractive

        # Installation of initial packages
        apt-get update -y
        apt-get install -y software-properties-common
        apt-get install -y wget vim apt-utils git build-essential bzip2 libpng-dev gfortran gfortran xvfb ghostscript curl pkg-config libxi-dev libfuse-dev python-is-python3
        add-apt-repository -y universe
        add-apt-repository -y multiverse
        add-apt-repository -y restricted
        add-apt-repository -s ppa:kernsuite/kern-7
        apt-get install -y casacore-dev casacore-data	

        # Update pip and install python packages
        apt-get install -y python3-pip
        pip install --upgrade cloudpickle holoviews datashader bokeh pandas dask-ms[xarray] scipy protobuf
        pip install --no-binary :all: python-casacore      

        # Install Jupyter for IPykernel
        pip install jupyter ipykernel

        # Install PyBDSF
        apt-get install -y libboost-python-dev libboost-numpy-dev python-setuptools
        pip install --upgrade numpy scikit-image
        pip install astropy==4.1 bdsf matplotlib katdal astroquery
        apt-get install -y pybdsf

        # Install CASA 6
        apt-get install -y libopenmpi-dev
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatools==6.4.4.31
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatasks==6.4.4.31
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple almatasks==1.5.2
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casampi==0.4.3
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casadata==2022.3.28
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casaplotserver==1.2.1
        # Install unvalidated packages
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casaplotms==1.5.5
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casaviewer==1.5.2
        pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casashell==6.4.4.31

        cd /opt
        git clone https://open-bitbucket.nrao.edu/scm/casa/casaaddons.git

        # Fix command prompt in Singularity 3.5.2
        printf 'export PS1="\u@$SINGULARITY_NAME:\w$ "' > /.singularity.d/env/999-psvars.sh

        # Cleanup the container
        apt-get clean
        apt-get autoclean

%runscript

	python "$@"
